<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Send Notifications - Admin</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/topbar.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/footer.css">
  <style>
    .notification-form {
      background: var(--card-bg, white);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      max-width: 600px;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-primary, #333);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color, #e0e0e0);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color, #4f46e5);
    }
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }
    .form-hint {
      font-size: 0.875rem;
      color: var(--text-secondary, #666);
      margin-top: 0.25rem;
    }
    .btn-send {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--primary-color, #4f46e5);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-send:hover {
      opacity: 0.9;
    }
    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .recipient-count {
      background: var(--bg-secondary, #f8f9fa);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    .recipient-count strong {
      color: var(--primary-color, #4f46e5);
    }
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    .success-message.show {
      display: block;
    }
    .quick-templates {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color, #e0e0e0);
    }
    .quick-templates h3 {
      margin-bottom: 1rem;
      font-size: 1rem;
      color: var(--text-secondary, #666);
    }
    .template-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .template-btn {
      padding: 0.5rem 1rem;
      background: var(--bg-secondary, #f8f9fa);
      border: 1px solid var(--border-color, #e0e0e0);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .template-btn:hover {
      background: var(--primary-color, #4f46e5);
      color: white;
      border-color: var(--primary-color, #4f46e5);
    }
  </style>
</head>
<body>
  <%- include('../partials/sidebar_admin') %>

  <div class="main-wrapper">
    <%- include('../partials/topbar', { pageTitle: 'Send Notifications' }) %>

    <main class="page-content">
      <div class="container">
        <div class="dashboard-wrapper">
          <div class="notification-form">
            <div class="success-message" id="successMessage">
              Notification sent successfully!
            </div>

            <form id="notificationForm">
              <div class="form-group">
                <label for="targetRole">Send To</label>
                <select id="targetRole" name="targetRole" required>
                  <option value="">Select recipients...</option>
                  <option value="all">All Users</option>
                  <option value="student">All Students</option>
                  <option value="sponsor">All Sponsors</option>
                </select>
                <div class="form-hint">Choose who should receive this notification</div>
              </div>

              <div class="recipient-count" id="recipientCount" style="display: none;">
                This will be sent to <strong id="countValue">0</strong> users
              </div>

              <div class="form-group">
                <label for="title">Notification Title</label>
                <input type="text" id="title" name="title" placeholder="Enter notification title..." required maxlength="100">
                <div class="form-hint">Keep it short and descriptive (max 100 characters)</div>
              </div>

              <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="Enter your message here..." required maxlength="500"></textarea>
                <div class="form-hint">The main content of your notification (max 500 characters)</div>
              </div>

              <button type="submit" class="btn-send" id="sendBtn">
                <span>üîî</span> Send Notification
              </button>
            </form>

            <div class="quick-templates">
              <h3>Quick Templates</h3>
              <div class="template-btns">
                <button type="button" class="template-btn" onclick="useTemplate('deadline')">Deadline Reminder</button>
                <button type="button" class="template-btn" onclick="useTemplate('newScholarship')">New Scholarship</button>
                <button type="button" class="template-btn" onclick="useTemplate('maintenance')">System Maintenance</button>
                <button type="button" class="template-btn" onclick="useTemplate('update')">Important Update</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <script src="/js/sidebar.js"></script>
  <script>
    const userCounts = {
      all: <%= stats.total %>,
      student: <%= stats.students %>,
      sponsor: <%= stats.sponsors %>
    };

    const templates = {
      deadline: {
        title: 'Application Deadline Reminder',
        message: 'This is a friendly reminder that some scholarship deadlines are approaching. Please check your applications and ensure all required documents are submitted before the deadline.'
      },
      newScholarship: {
        title: 'New Scholarship Opportunities Available',
        message: 'New scholarship opportunities have been added to our platform. Log in now to view and apply for these scholarships before they close.'
      },
      maintenance: {
        title: 'Scheduled System Maintenance',
        message: 'We will be performing scheduled maintenance on our system. During this time, the platform may be temporarily unavailable. We apologize for any inconvenience.'
      },
      update: {
        title: 'Important System Update',
        message: 'We have made some important updates to our platform. Please log in to review any changes that may affect your account or applications.'
      }
    };

    document.getElementById('targetRole').addEventListener('change', function() {
      const role = this.value;
      const countDiv = document.getElementById('recipientCount');
      const countValue = document.getElementById('countValue');

      if (role && userCounts[role] !== undefined) {
        countValue.textContent = userCounts[role];
        countDiv.style.display = 'block';
      } else {
        countDiv.style.display = 'none';
      }
    });

    function useTemplate(templateName) {
      const template = templates[templateName];
      if (template) {
        document.getElementById('title').value = template.title;
        document.getElementById('message').value = template.message;
      }
    }

    document.getElementById('notificationForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>‚è≥</span> Sending...';

      const data = {
        targetRole: document.getElementById('targetRole').value,
        title: document.getElementById('title').value,
        message: document.getElementById('message').value
      };

      fetch('/admin/notifications/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          btn.disabled = false;
          btn.innerHTML = '<span>üîî</span> Send Notification';

          if (result.success) {
            document.getElementById('successMessage').classList.add('show');
            document.getElementById('successMessage').textContent = result.message;
            document.getElementById('notificationForm').reset();
            document.getElementById('recipientCount').style.display = 'none';

            setTimeout(() => {
              document.getElementById('successMessage').classList.remove('show');
            }, 5000);
          } else {
            alert('Error: ' + result.error);
          }
        })
        .catch(err => {
          btn.disabled = false;
          btn.innerHTML = '<span>üîî</span> Send Notification';
          alert('Error sending notification');
        });
    });
  </script>
</body>
</html>
