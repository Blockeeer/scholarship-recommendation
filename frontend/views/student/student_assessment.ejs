<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Assessment - Scholarship Portal</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/topbar.css">
  <link rel="stylesheet" href="/css/footer.css">
  <style>
    .assessment-page {
      max-width: 800px;
      margin: 0 auto;
    }

    .assessment-card {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .assessment-header {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .assessment-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      color: white;
    }

    .assessment-header p {
      opacity: 0.95;
      font-size: 0.9375rem;
      color: white;
    }

    .form-body {
      padding: 2rem;
    }

    .form-section {
      margin-bottom: 2rem;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--primary-color);
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group label .required {
      color: #ef4444;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.9375rem;
      transition: all var(--transition);
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--primary-100);
    }

    .form-group input:read-only {
      background: var(--bg-secondary);
      cursor: not-allowed;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-hint {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.375rem;
    }

    /* Checkbox group for skills */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 0.875rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition);
    }

    .checkbox-item:hover {
      border-color: var(--primary-color);
      background: var(--primary-50);
    }

    .checkbox-item input {
      width: auto;
      margin: 0;
      cursor: pointer;
      pointer-events: none;
    }

    .checkbox-item.checked {
      background: var(--primary-50);
      border-color: var(--primary-color);
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
      color: var(--text-primary);
    }

    /* File upload */
    .file-upload {
      position: relative;
    }

    .file-upload input[type="file"] {
      padding: 0.75rem;
      border: 2px dashed var(--border-color);
      background: var(--bg-secondary);
      cursor: pointer;
    }

    .file-upload input[type="file"]:hover {
      border-color: var(--primary-color);
      background: var(--primary-50);
    }

    .current-file {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--success-50);
      border-radius: var(--radius);
      font-size: 0.8125rem;
      color: var(--success-700);
    }

    /* Submit button */
    .submit-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
    }

    .btn-submit {
      width: 100%;
      padding: 1rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 1.0625rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Progress indicator */
    .progress-bar {
      background: var(--bg-secondary);
      height: 6px;
      border-radius: 3px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <%- include('../partials/sidebar_student') %>

  <div class="main-wrapper">
    <%- include('../partials/topbar', { pageTitle: 'Profile Assessment' }) %>

    <main class="page-content">
      <div class="assessment-page">
        <div class="assessment-card">
          <div class="assessment-header">
            <h1><%= hasCompletedAssessment ? 'Update Your Profile' : 'Complete Your Profile' %></h1>
            <p><%= hasCompletedAssessment ? 'Keep your information up to date for better scholarship matches' : 'Fill out this form to get personalized scholarship recommendations' %></p>
          </div>

          <% if (typeof redirectScholarshipId !== 'undefined' && redirectScholarshipId) { %>
          <div style="background: var(--primary-50); border-left: 4px solid var(--primary-500); padding: 1rem 1.5rem; margin: 1rem 1.5rem 0;">
            <strong style="color: var(--primary-700);">Complete your profile to apply</strong>
            <p style="margin: 0.5rem 0 0; color: var(--text-secondary); font-size: 0.875rem;">Please fill out this assessment form first. After submission, you will be redirected to complete your scholarship application.</p>
          </div>
          <% } %>

          <div class="form-body">
            <div class="progress-text">Complete all sections to maximize your scholarship matches</div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <form action="/student/assessment" method="POST" enctype="multipart/form-data" id="assessmentForm">
              <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
              <% if (typeof redirectScholarshipId !== 'undefined' && redirectScholarshipId) { %>
                <input type="hidden" name="redirectScholarshipId" value="<%= redirectScholarshipId %>">
              <% } %>

              <!-- Personal Information -->
              <div class="form-section">
                <h2 class="section-title">
                  Personal Information
                </h2>

                <div class="form-row">
                  <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" name="fullName" id="fullName" value="<%= assessmentData && assessmentData.fullName ? assessmentData.fullName : '' %>" placeholder="Enter your full name" required>
                  </div>

                  <div class="form-group">
                    <label>Age <span class="required">*</span></label>
                    <input type="number" name="age" id="age" min="15" max="60" value="<%= assessmentData && assessmentData.age ? assessmentData.age : '' %>" placeholder="Enter your age" required>
                  </div>
                </div>

                <div class="form-group">
                  <label>Gender <span class="required">*</span></label>
                  <select name="gender" id="gender" required>
                    <option value="">Select gender...</option>
                    <option value="Male" <%= assessmentData && assessmentData.gender === 'Male' ? 'selected' : '' %>>Male</option>
                    <option value="Female" <%= assessmentData && assessmentData.gender === 'Female' ? 'selected' : '' %>>Female</option>
                    <option value="Other" <%= assessmentData && assessmentData.gender === 'Other' ? 'selected' : '' %>>Other</option>
                    <option value="Prefer not to say" <%= assessmentData && assessmentData.gender === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
                  </select>
                </div>
              </div>

              <!-- Academic Information -->
              <div class="form-section">
                <h2 class="section-title">
                  Academic Information
                </h2>

                <div class="form-group">
                  <label>Course / Program <span class="required">*</span></label>
                  <select name="course" id="course" required>
                    <option value="">Select your course...</option>
                    <option value="Computer Science" <%= assessmentData && assessmentData.course === 'Computer Science' ? 'selected' : '' %>>Computer Science</option>
                    <option value="Information Technology" <%= assessmentData && assessmentData.course === 'Information Technology' ? 'selected' : '' %>>Information Technology</option>
                    <option value="Engineering" <%= assessmentData && assessmentData.course === 'Engineering' ? 'selected' : '' %>>Engineering</option>
                    <option value="Business Administration" <%= assessmentData && assessmentData.course === 'Business Administration' ? 'selected' : '' %>>Business Administration</option>
                    <option value="Accountancy" <%= assessmentData && assessmentData.course === 'Accountancy' ? 'selected' : '' %>>Accountancy</option>
                    <option value="Education" <%= assessmentData && assessmentData.course === 'Education' ? 'selected' : '' %>>Education</option>
                    <option value="Nursing" <%= assessmentData && assessmentData.course === 'Nursing' ? 'selected' : '' %>>Nursing</option>
                    <option value="Medical Technology" <%= assessmentData && assessmentData.course === 'Medical Technology' ? 'selected' : '' %>>Medical Technology</option>
                    <option value="Psychology" <%= assessmentData && assessmentData.course === 'Psychology' ? 'selected' : '' %>>Psychology</option>
                    <option value="Architecture" <%= assessmentData && assessmentData.course === 'Architecture' ? 'selected' : '' %>>Architecture</option>
                    <option value="Fine Arts" <%= assessmentData && assessmentData.course === 'Fine Arts' ? 'selected' : '' %>>Fine Arts</option>
                    <option value="Mass Communication" <%= assessmentData && assessmentData.course === 'Mass Communication' ? 'selected' : '' %>>Mass Communication</option>
                    <option value="Hospitality Management" <%= assessmentData && assessmentData.course === 'Hospitality Management' ? 'selected' : '' %>>Hospitality Management</option>
                    <option value="Tourism" <%= assessmentData && assessmentData.course === 'Tourism' ? 'selected' : '' %>>Tourism</option>
                    <option value="Criminology" <%= assessmentData && assessmentData.course === 'Criminology' ? 'selected' : '' %>>Criminology</option>
                    <option value="Other" <%= assessmentData && assessmentData.course === 'Other' ? 'selected' : '' %>>Other</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Year Level <span class="required">*</span></label>
                    <select name="yearLevel" id="yearLevel" required>
                      <option value="">Select year level...</option>
                      <option value="1st Year" <%= assessmentData && assessmentData.yearLevel === '1st Year' ? 'selected' : '' %>>1st Year</option>
                      <option value="2nd Year" <%= assessmentData && assessmentData.yearLevel === '2nd Year' ? 'selected' : '' %>>2nd Year</option>
                      <option value="3rd Year" <%= assessmentData && assessmentData.yearLevel === '3rd Year' ? 'selected' : '' %>>3rd Year</option>
                      <option value="4th Year" <%= assessmentData && assessmentData.yearLevel === '4th Year' ? 'selected' : '' %>>4th Year</option>
                      <option value="5th Year" <%= assessmentData && assessmentData.yearLevel === '5th Year' ? 'selected' : '' %>>5th Year</option>
                      <option value="Graduate" <%= assessmentData && assessmentData.yearLevel === 'Graduate' ? 'selected' : '' %>>Graduate Student</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>GPA / GWA <span class="required">*</span></label>
                    <input type="number" name="gpa" id="gpa" step="0.01" min="1.0" max="5.0" value="<%= assessmentData && assessmentData.gpa ? assessmentData.gpa : '' %>" placeholder="e.g., 1.50 or 3.50" required>
                    <div class="form-hint">Enter your GPA (1.0-5.0 scale or percentage)</div>
                  </div>
                </div>
              </div>

              <!-- Financial Information -->
              <div class="form-section">
                <h2 class="section-title">
                  Financial Information
                </h2>

                <div class="form-group">
                  <label>Monthly Family Income <span class="required">*</span></label>
                  <select name="incomeRange" id="incomeRange" required>
                    <option value="">Select income range...</option>
                    <option value="below_10k" <%= assessmentData && assessmentData.incomeRange === 'below_10k' ? 'selected' : '' %>>Below ₱10,000</option>
                    <option value="10k_20k" <%= assessmentData && assessmentData.incomeRange === '10k_20k' ? 'selected' : '' %>>₱10,000 - ₱20,000</option>
                    <option value="20k_30k" <%= assessmentData && assessmentData.incomeRange === '20k_30k' ? 'selected' : '' %>>₱20,000 - ₱30,000</option>
                    <option value="30k_50k" <%= assessmentData && assessmentData.incomeRange === '30k_50k' ? 'selected' : '' %>>₱30,000 - ₱50,000</option>
                    <option value="above_50k" <%= assessmentData && assessmentData.incomeRange === 'above_50k' ? 'selected' : '' %>>Above ₱50,000</option>
                  </select>
                  <div class="form-hint">This helps match you with need-based scholarships</div>
                </div>
              </div>

              <!-- Scholarship Preferences -->
              <div class="form-section">
                <h2 class="section-title">
                  Scholarship Preferences
                </h2>

                <div class="form-group">
                  <label>Preferred Scholarship Type <span class="required">*</span></label>
                  <select name="scholarshipType" id="scholarshipType" required>
                    <option value="">Select scholarship type...</option>
                    <option value="Merit" <%= assessmentData && assessmentData.scholarshipType === 'Merit' ? 'selected' : '' %>>Merit-based (Academic Excellence)</option>
                    <option value="Need-based" <%= assessmentData && assessmentData.scholarshipType === 'Need-based' ? 'selected' : '' %>>Need-based (Financial Aid)</option>
                    <option value="Athletic" <%= assessmentData && assessmentData.scholarshipType === 'Athletic' ? 'selected' : '' %>>Athletic (Sports)</option>
                    <option value="Leadership" <%= assessmentData && assessmentData.scholarshipType === 'Leadership' ? 'selected' : '' %>>Leadership</option>
                    <option value="Arts" <%= assessmentData && assessmentData.scholarshipType === 'Arts' ? 'selected' : '' %>>Arts & Creativity</option>
                    <option value="STEM" <%= assessmentData && assessmentData.scholarshipType === 'STEM' ? 'selected' : '' %>>STEM (Science & Technology)</option>
                    <option value="Community Service" <%= assessmentData && assessmentData.scholarshipType === 'Community Service' ? 'selected' : '' %>>Community Service</option>
                  </select>
                </div>
              </div>

              <!-- Skills & Qualities -->
              <div class="form-section">
                <h2 class="section-title">
                  Skills & Qualities
                </h2>

                <div class="form-group">
                  <label>Select your skills and qualities (check all that apply)</label>
                  <div class="checkbox-grid">
                    <%
                      const skillOptions = [
                        'Leadership', 'Communication', 'Teamwork', 'Problem Solving',
                        'Critical Thinking', 'Programming', 'Research', 'Writing',
                        'Public Speaking', 'Innovation', 'Creativity', 'Time Management',
                        'Community Service', 'Sports', 'Music', 'Arts'
                      ];
                      const savedSkills = assessmentData && assessmentData.skills ? (Array.isArray(assessmentData.skills) ? assessmentData.skills : assessmentData.skills.split(',').map(s => s.trim())) : [];
                    %>
                    <% skillOptions.forEach(skill => { %>
                      <div class="checkbox-item <%= savedSkills.includes(skill) ? 'checked' : '' %>" onclick="toggleCheckbox(this)">
                        <input type="checkbox" name="skills" value="<%= skill %>" <%= savedSkills.includes(skill) ? 'checked' : '' %>>
                        <label><%= skill %></label>
                      </div>
                    <% }) %>
                  </div>
                </div>

                <div class="form-group">
                  <label>Other Achievements & Experiences</label>
                  <textarea name="achievements" id="achievements" placeholder="List any awards, certifications, or notable achievements..."><%= assessmentData && assessmentData.achievements ? assessmentData.achievements : '' %></textarea>
                </div>
              </div>

              <!-- Community Involvement -->
              <div class="form-section">
                <h2 class="section-title">
                  Community Involvement
                </h2>

                <div class="form-group">
                  <label>Extracurricular Activities & Volunteer Work</label>
                  <textarea name="involvement" id="involvement" placeholder="Describe your community service, organizations, and extracurricular activities..."><%= assessmentData && assessmentData.involvement ? assessmentData.involvement : '' %></textarea>
                  <div class="form-hint">This is important for leadership and community service scholarships</div>
                </div>
              </div>

              <!-- Essay -->
              <div class="form-section">
                <h2 class="section-title">
                  Personal Statement
                </h2>

                <div class="form-group">
                  <label>Why are you applying for a scholarship? <span class="required">*</span></label>
                  <textarea name="essayReason" id="essayReason" placeholder="Share your story, goals, and why you deserve this scholarship..." required><%= assessmentData && assessmentData.essayReason ? assessmentData.essayReason : '' %></textarea>
                  <div class="form-hint">Minimum 100 characters. Be authentic and specific about your goals.</div>
                </div>
              </div>

              <!-- Document Uploads -->
              <div class="form-section">
                <h2 class="section-title">
                  Required Documents
                </h2>

                <%
                  const uploadedFiles = assessmentData && assessmentData.files ? assessmentData.files : {};
                %>

                <div class="form-group file-upload">
                  <label>Transcript of Grades <span class="required">*</span></label>
                  <input type="file" name="grades" id="grades" accept=".pdf,.jpg,.jpeg,.png" <%= hasCompletedAssessment ? '' : 'required' %>>
                  <div class="form-hint">PDF, JPG, or PNG format (max 5MB)</div>
                  <% if (hasCompletedAssessment && uploadedFiles.grades) { %>
                    <div class="current-file">
                      <a href="<%= uploadedFiles.grades %>" target="_blank" style="color: inherit; text-decoration: underline;">
                        View current file
                      </a>
                      - upload new to replace
                    </div>
                  <% } %>
                </div>

                <div class="form-group file-upload">
                  <label>Certificate of Enrollment <span class="required">*</span></label>
                  <input type="file" name="coe" id="coe" accept=".pdf,.jpg,.jpeg,.png" <%= hasCompletedAssessment ? '' : 'required' %>>
                  <div class="form-hint">PDF, JPG, or PNG format (max 5MB)</div>
                  <% if (hasCompletedAssessment && uploadedFiles.coe) { %>
                    <div class="current-file">
                      <a href="<%= uploadedFiles.coe %>" target="_blank" style="color: inherit; text-decoration: underline;">
                        View current file
                      </a>
                      - upload new to replace
                    </div>
                  <% } %>
                </div>

                <div class="form-group file-upload">
                  <label>School ID <span class="required">*</span></label>
                  <input type="file" name="schoolId" id="schoolId" accept=".pdf,.jpg,.jpeg,.png" <%= hasCompletedAssessment ? '' : 'required' %>>
                  <div class="form-hint">PDF, JPG, or PNG format (max 5MB)</div>
                  <% if (hasCompletedAssessment && uploadedFiles.schoolId) { %>
                    <div class="current-file">
                      <a href="<%= uploadedFiles.schoolId %>" target="_blank" style="color: inherit; text-decoration: underline;">
                        View current file
                      </a>
                      - upload new to replace
                    </div>
                  <% } %>
                </div>

                <div class="form-group file-upload">
                  <label>Other Supporting Documents (Optional)</label>
                  <input type="file" name="otherDocuments" id="otherDocuments" accept=".pdf,.jpg,.jpeg,.png" multiple>
                  <div class="form-hint">You may upload multiple files - certificates, awards, etc.</div>
                  <% if (hasCompletedAssessment && uploadedFiles.otherDocuments && uploadedFiles.otherDocuments.length > 0) { %>
                    <div class="current-file">
                      <%= uploadedFiles.otherDocuments.length %> file(s) uploaded:
                      <% uploadedFiles.otherDocuments.forEach(function(fileUrl, index) { %>
                        <a href="<%= fileUrl %>" target="_blank" style="color: inherit; text-decoration: underline; margin-left: 0.5rem;">
                          File <%= index + 1 %>
                        </a>
                      <% }); %>
                    </div>
                  <% } %>
                </div>
              </div>

              <!-- Submit -->
              <div class="submit-section">
                <button type="submit" class="btn-submit" id="submitBtn">
                  <%= hasCompletedAssessment ? 'Save Changes' : 'Submit Assessment' %>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <script src="/js/sidebar.js"></script>
  <script>
    const form = document.getElementById('assessmentForm');
    const submitBtn = document.getElementById('submitBtn');
    const hasCompletedAssessment = "<%= hasCompletedAssessment ? 'yes' : 'no' %>" === "yes";
    const progressFill = document.getElementById('progressFill');

    // Toggle checkbox styling
    function toggleCheckbox(item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      item.classList.toggle('checked', checkbox.checked);
      updateProgress();
    }

    // Update progress bar
    function updateProgress() {
      const requiredFields = form.querySelectorAll('[required]');
      let filled = 0;
      let total = requiredFields.length;

      requiredFields.forEach(field => {
        if (field.type === 'file') {
          if (field.files.length > 0 || hasCompletedAssessment) filled++;
        } else if (field.value.trim() !== '') {
          filled++;
        }
      });

      const percentage = Math.round((filled / total) * 100);
      progressFill.style.width = percentage + '%';
    }

    // Listen for input changes
    form.querySelectorAll('input, select, textarea').forEach(field => {
      field.addEventListener('change', updateProgress);
      field.addEventListener('input', updateProgress);
    });

    // Initial progress update
    updateProgress();

    // Form submission
    form.addEventListener('submit', function(e) {
      // Validate essay length
      const essay = document.getElementById('essayReason').value;
      if (essay.length < 100) {
        e.preventDefault();
        alert('Your personal statement must be at least 100 characters long.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = hasCompletedAssessment ? 'Saving...' : 'Submitting...';
    });
  </script>
</body>
</html>
