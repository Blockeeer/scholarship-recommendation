<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard - Scholarship Portal</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/topbar.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/footer.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<%
  // Default values for variables if not provided
  const stats = typeof applicationStats !== 'undefined' ? applicationStats : { total: 0, pending: 0, accepted: 0, notified: 0, notSelected: 0 };
  const scholarships = typeof availableScholarships !== 'undefined' ? availableScholarships : 0;
  const notifications = typeof unreadNotifications !== 'undefined' ? unreadNotifications : 0;
  const assessment = typeof hasAssessment !== 'undefined' ? hasAssessment : false;
%>
<body>
  <%- include('../partials/sidebar_student') %>

  <div class="main-wrapper">
    <%- include('../partials/topbar', { pageTitle: 'Dashboard' }) %>

    <main class="page-content">
      <div class="container">
      <div class="dashboard-wrapper">
        <div class="welcome-banner">
          <div class="welcome-content">
            <h1>Welcome, <%= fullName || 'Student' %>!</h1>
            <p>Discover scholarship opportunities tailored for you</p>
          </div>
          <div class="welcome-icon"></div>
        </div>

        <% if (!assessment) { %>
          <div class="alert alert-warning">
            <strong>Complete Your Profile!</strong> To get personalized scholarship recommendations, please complete your assessment.
            <a href="/student/assessment" style="color: inherit; font-weight: bold; margin-left: 0.5rem;">Complete Now ‚Üí</a>
          </div>
        <% } %>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">üìÑ</div>
            </div>
            <div class="stat-value"><%= stats.total %></div>
            <div class="stat-label">Total Applications</div>
            <div class="stat-trend"><%= stats.pending %> pending</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">‚úÖ</div>
            </div>
            <div class="stat-value"><%= (stats.accepted || 0) + (stats.notified || 0) %></div>
            <div class="stat-label">Accepted</div>
            <div class="stat-trend trend-up"><%= stats.notified || 0 %> notified</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">üéì</div>
            </div>
            <div class="stat-value"><%= scholarships %></div>
            <div class="stat-label">Available</div>
            <div class="stat-trend">Scholarships</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">üîî</div>
            </div>
            <div class="stat-value"><%= notifications %></div>
            <div class="stat-label">Notifications</div>
            <div class="stat-trend">Unread</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
          <div class="chart-card">
            <h3>Application Status</h3>
            <div class="chart-container">
              <% if (stats.total > 0) { %>
                <canvas id="applicationChart"></canvas>
              <% } else { %>
                <div class="chart-empty">
                  <div class="chart-empty-icon">üìä</div>
                  Apply to scholarships to see your status breakdown
                </div>
              <% } %>
            </div>
            <% if (stats.total > 0) { %>
            <div class="chart-stats">
              <div class="chart-stat">
                <div class="chart-stat-value" style="color: #10b981;"><%= (stats.accepted || 0) + (stats.notified || 0) %></div>
                <div class="chart-stat-label">Accepted</div>
              </div>
              <div class="chart-stat">
                <div class="chart-stat-value" style="color: #f59e0b;"><%= stats.pending %></div>
                <div class="chart-stat-label">Pending</div>
              </div>
              <div class="chart-stat">
                <div class="chart-stat-value" style="color: #ef4444;"><%= stats.notSelected || 0 %></div>
                <div class="chart-stat-label">Not Selected</div>
              </div>
            </div>
            <% } %>
          </div>
          <div class="chart-card">
            <h3>Success Rate</h3>
            <div class="chart-container">
              <% if (stats.total > 0) { %>
                <canvas id="successChart"></canvas>
              <% } else { %>
                <div class="chart-empty">
                  <div class="chart-empty-icon">üèÜ</div>
                  Your success metrics will appear here
                </div>
              <% } %>
            </div>
            <% if (stats.total > 0) { %>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-dot primary"></span>
                <span>Approved Applications</span>
              </div>
            </div>
            <% } %>
          </div>
        </div>

        <div class="action-grid">
          <div class="action-card">
            <div class="action-icon"></div>
            <h2 class="action-title">View Recommendations</h2>
            <p class="action-description">Personalized scholarship matches based on your profile</p>
            <a href="/student/recommendations" class="btn btn-primary">See Recommendations</a>
          </div>

          <div class="action-card">
            <div class="action-icon"></div>
            <h2 class="action-title">Search Scholarships</h2>
            <p class="action-description">Browse all available scholarship opportunities</p>
            <a href="/student/scholarships" class="btn btn-primary">Search Now</a>
          </div>

          <div class="action-card">
            <div class="action-icon"></div>
            <h2 class="action-title">My Applications</h2>
            <p class="action-description">Track your scholarship application status</p>
            <a href="/student/applications" class="btn btn-primary">View Applications</a>
          </div>
        </div>

        <div class="recent-activity">
          <h2 class="section-title">Recent Activity</h2>
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <p>Your recent activity will appear here</p>
            <div class="quick-actions">
              <a href="/student/recommendations" class="quick-action-btn">Explore Recommendations</a>
            </div>
          </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <script src="/js/sidebar.js"></script>
  <script>
    <% if (stats.total > 0) { %>
    // Application Status Doughnut Chart
    const acceptedCount = <%= (stats.accepted || 0) + (stats.notified || 0) %>;
    new Chart(document.getElementById('applicationChart'), {
      type: 'doughnut',
      data: {
        labels: ['Accepted', 'Pending', 'Not Selected'],
        datasets: [{
          data: [acceptedCount, <%= stats.pending %>, <%= stats.notSelected || 0 %>],
          backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });

    // Success Rate Chart
    const successRate = acceptedCount > 0
      ? Math.round((acceptedCount / <%= stats.total %>) * 100)
      : 0;

    new Chart(document.getElementById('successChart'), {
      type: 'doughnut',
      data: {
        labels: ['Success', 'Other'],
        datasets: [{
          data: [successRate, 100 - successRate],
          backgroundColor: ['#667eea', '#e5e7eb'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            display: false
          }
        }
      },
      plugins: [{
        id: 'centerText',
        beforeDraw: function(chart) {
          const width = chart.width;
          const height = chart.height;
          const ctx = chart.ctx;
          ctx.restore();
          const fontSize = (height / 114).toFixed(2);
          ctx.font = 'bold ' + fontSize + 'em sans-serif';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = '#667eea';
          const text = successRate + '%';
          const textX = Math.round((width - ctx.measureText(text).width) / 2);
          const textY = height / 2;
          ctx.fillText(text, textX, textY);
          ctx.save();
        }
      }]
    });
    <% } %>
  </script>
</body>
</html>