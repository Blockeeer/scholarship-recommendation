<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sponsor Dashboard - Scholarship Portal</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/topbar.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/footer.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<%
  // Default values for variables if not provided
  const schStats = typeof scholarshipStats !== 'undefined' ? scholarshipStats : { total: 0, open: 0, pending: 0, closed: 0, totalSlots: 0, filledSlots: 0 };
  const appStats = typeof applicationStats !== 'undefined' ? applicationStats : { total: 0, pending: 0, approved: 0, rejected: 0 };
%>
<body>
  <%- include('../partials/sidebar_sponsor') %>

  <div class="main-wrapper">
    <%- include('../partials/topbar', { pageTitle: 'Dashboard' }) %>

    <main class="page-content">
      <div class="container">
        <div class="dashboard-wrapper">
  <!-- Welcome Banner -->
  <div class="welcome-banner">
    <div class="welcome-content">
      <h1>Welcome, <%= fullName || 'Sponsor' %>!</h1>
      <p>Manage your scholarship offers and connect with students</p>
    </div>
    <div class="welcome-icon"></div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon"></div>
      </div>
      <div class="stat-value"><%= schStats.open %></div>
      <div class="stat-label">Active Scholarships</div>
      <div class="stat-trend"><%= schStats.pending %> pending approval</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon"></div>
      </div>
      <div class="stat-value"><%= appStats.total %></div>
      <div class="stat-label">Total Applications</div>
      <div class="stat-trend"><%= appStats.approved %> approved</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon"></div>
      </div>
      <div class="stat-value"><%= appStats.pending %></div>
      <div class="stat-label">Pending Reviews</div>
      <div class="stat-trend">Action required</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon"></div>
      </div>
      <div class="stat-value"><%= schStats.totalSlots - schStats.filledSlots %></div>
      <div class="stat-label">Available Slots</div>
      <div class="stat-trend"><%= schStats.filledSlots %> filled</div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>Scholarship Status</h3>
      <div class="chart-container">
        <% if (schStats.total > 0) { %>
          <canvas id="scholarshipChart"></canvas>
        <% } else { %>
          <div class="chart-empty">
            <div class="chart-empty-icon">ðŸŽ“</div>
            Create scholarships to see status distribution
          </div>
        <% } %>
      </div>
      <% if (schStats.total > 0) { %>
      <div class="chart-stats">
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #10b981;"><%= schStats.open %></div>
          <div class="chart-stat-label">Open</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #f59e0b;"><%= schStats.pending %></div>
          <div class="chart-stat-label">Pending</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #6b7280;"><%= schStats.closed || 0 %></div>
          <div class="chart-stat-label">Closed</div>
        </div>
      </div>
      <% } %>
    </div>
    <div class="chart-card">
      <h3>Application Status</h3>
      <div class="chart-container">
        <% if (appStats.total > 0) { %>
          <canvas id="applicationChart"></canvas>
        <% } else { %>
          <div class="chart-empty">
            <div class="chart-empty-icon">ðŸ“„</div>
            Receive applications to see status breakdown
          </div>
        <% } %>
      </div>
      <% if (appStats.total > 0) { %>
      <div class="chart-stats">
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #10b981;"><%= appStats.approved %></div>
          <div class="chart-stat-label">Approved</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #f59e0b;"><%= appStats.pending %></div>
          <div class="chart-stat-label">Pending</div>
        </div>
        <div class="chart-stat">
          <div class="chart-stat-value" style="color: #ef4444;"><%= appStats.rejected || 0 %></div>
          <div class="chart-stat-label">Rejected</div>
        </div>
      </div>
      <% } %>
    </div>
    <div class="chart-card">
      <h3>Slot Utilization</h3>
      <div class="chart-container">
        <% if (schStats.totalSlots > 0) { %>
          <canvas id="slotChart"></canvas>
        <% } else { %>
          <div class="chart-empty">
            <div class="chart-empty-icon">ðŸ“ˆ</div>
            Add scholarship slots to track utilization
          </div>
        <% } %>
      </div>
      <% if (schStats.totalSlots > 0) { %>
      <div class="chart-legend">
        <div class="legend-item">
          <span class="legend-dot primary"></span>
          <span>Filled (<%= schStats.filledSlots %>)</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #e5e7eb;"></span>
          <span>Available (<%= schStats.totalSlots - schStats.filledSlots %>)</span>
        </div>
      </div>
      <% } %>
    </div>
    <div class="chart-card">
      <h3>Application Conversion</h3>
      <div class="chart-container">
        <% if (appStats.total > 0) { %>
          <canvas id="conversionChart"></canvas>
        <% } else { %>
          <div class="chart-empty">
            <div class="chart-empty-icon">ðŸŽ¯</div>
            Review applications to see conversion rates
          </div>
        <% } %>
      </div>
      <% if (appStats.total > 0) { %>
      <div class="chart-legend">
        <div class="legend-item">
          <span class="legend-dot success"></span>
          <span>Conversion Rate</span>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Action Cards -->
  <div class="action-grid">
    <div class="action-card">
      <div class="action-icon"></div>
      <h2 class="action-title">Create New Offer</h2>
      <p class="action-description">Add a new scholarship opportunity for students</p>
      <a href="/sponsor/add-offer" class="btn btn-primary">Create Scholarship</a>
    </div>

    <div class="action-card">
      <div class="action-icon"></div>
      <h2 class="action-title">Manage Offers</h2>
      <p class="action-description">View and edit your existing scholarship listings</p>
      <a href="/sponsor/offers" class="btn btn-primary">View My Offers</a>
    </div>

    <div class="action-card">
      <div class="action-icon"></div>
      <h2 class="action-title">Review Applicants</h2>
      <p class="action-description">Review and approve student applications</p>
      <a href="/sponsor/offers" class="btn btn-primary">View Applications</a>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="recent-activity">
    <h2 class="section-title">Recent Activity</h2>
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“Š</div>
      <p>Your recent scholarship activity will appear here</p>
      <div class="quick-actions">
        <a href="/sponsor/add-offer" class="quick-action-btn">Create Your First Scholarship</a>
      </div>
    </div>
  </div>
        </div>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <script src="/js/sidebar.js"></script>
  <script>
    // Chart data from server
    const chartData = {
      scholarships: {
        open: <%= schStats.open %>,
        pending: <%= schStats.pending %>,
        closed: <%= schStats.closed || 0 %>
      },
      applications: {
        approved: <%= appStats.approved %>,
        pending: <%= appStats.pending %>,
        rejected: <%= appStats.rejected || 0 %>
      },
      slots: {
        filled: <%= schStats.filledSlots %>,
        available: <%= schStats.totalSlots - schStats.filledSlots %>
      }
    };

    // Scholarship Status Doughnut Chart
    <% if (schStats.total > 0) { %>
    new Chart(document.getElementById('scholarshipChart'), {
      type: 'doughnut',
      data: {
        labels: ['Open', 'Pending', 'Closed'],
        datasets: [{
          data: [chartData.scholarships.open, chartData.scholarships.pending, chartData.scholarships.closed],
          backgroundColor: ['#10b981', '#f59e0b', '#6b7280'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
    <% } %>

    // Application Status Bar Chart
    <% if (appStats.total > 0) { %>
    new Chart(document.getElementById('applicationChart'), {
      type: 'bar',
      data: {
        labels: ['Approved', 'Pending', 'Rejected'],
        datasets: [{
          label: 'Applications',
          data: [chartData.applications.approved, chartData.applications.pending, chartData.applications.rejected],
          backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
    <% } %>

    // Slot Utilization Doughnut Chart
    <% if (schStats.totalSlots > 0) { %>
    new Chart(document.getElementById('slotChart'), {
      type: 'doughnut',
      data: {
        labels: ['Filled', 'Available'],
        datasets: [{
          data: [chartData.slots.filled, chartData.slots.available],
          backgroundColor: ['#667eea', '#e5e7eb'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
    <% } %>

    // Conversion Rate Chart
    <% if (appStats.total > 0) { %>
    const conversionRate = chartData.applications.approved > 0
      ? Math.round((chartData.applications.approved / (chartData.applications.approved + chartData.applications.pending + chartData.applications.rejected)) * 100)
      : 0;

    new Chart(document.getElementById('conversionChart'), {
      type: 'doughnut',
      data: {
        labels: ['Approved', 'Other'],
        datasets: [{
          data: [conversionRate, 100 - conversionRate],
          backgroundColor: ['#10b981', '#e5e7eb'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.raw + '%';
              }
            }
          }
        }
      },
      plugins: [{
        id: 'centerText',
        beforeDraw: function(chart) {
          const width = chart.width;
          const height = chart.height;
          const ctx = chart.ctx;
          ctx.restore();
          const fontSize = (height / 114).toFixed(2);
          ctx.font = 'bold ' + fontSize + 'em sans-serif';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = '#10b981';
          const text = conversionRate + '%';
          const textX = Math.round((width - ctx.measureText(text).width) / 2);
          const textY = height / 2;
          ctx.fillText(text, textX, textY);
          ctx.save();
        }
      }]
    });
    <% } %>
  </script>
</body>
</html>