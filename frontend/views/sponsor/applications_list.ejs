<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Applications - <%= scholarship.scholarshipName %></title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/topbar.css">
  <link rel="stylesheet" href="/css/footer.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .back-link {
      color: #667eea;
      text-decoration: none;
      margin-bottom: 1rem;
      display: inline-block;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .info-banner {
      background: #e0f2fe;
      border: 1px solid #7dd3fc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #0369a1;
    }

    .info-banner strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.25rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card.pending .stat-value { color: #f59e0b; }
    .stat-card.accepted .stat-value { color: #10b981; }
    .stat-card.notified .stat-value { color: #3b82f6; }

    .actions-bar {
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-group label {
      font-weight: 600;
      color: #555;
    }

    .filter-group select {
      padding: 0.5rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-accept {
      background: #10b981;
      color: white;
    }

    .btn-accept:hover {
      background: #059669;
    }

    .btn-undo {
      background: #6b7280;
      color: white;
    }

    .applications-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .application-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: 60px 1fr auto;
      gap: 1.5rem;
      align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 4px solid #e5e7eb;
    }

    .application-card.status-accepted {
      border-left-color: #10b981;
      background: #f0fdf4;
    }

    .application-card.status-notified {
      border-left-color: #3b82f6;
      background: #eff6ff;
    }

    .application-card.status-not_selected {
      border-left-color: #6b7280;
      opacity: 0.7;
    }

    .application-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .rank-badge {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .rank-badge.gold {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #333;
    }

    .rank-badge.silver {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
      color: #333;
    }

    .rank-badge.bronze {
      background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
      color: white;
    }

    .rank-badge.unranked {
      background: #e0e0e0;
      color: #666;
      font-size: 1rem;
    }

    .rank-badge.accepted-badge {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: white;
      font-size: 1.5rem;
    }

    .rank-badge.notified-badge {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
      font-size: 1.5rem;
    }

    .rank-badge.not-selected-badge {
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
      color: white;
      font-size: 1.5rem;
    }

    .applicant-info {
      flex: 1;
    }

    .applicant-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .applicant-details {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #666;
      font-size: 0.9rem;
    }

    .detail-item strong {
      color: #333;
    }

    .match-score {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .status-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-under_review {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-accepted {
      background: #d1fae5;
      color: #065f46;
    }

    .status-notified {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-not_selected {
      background: #e5e7eb;
      color: #374151;
    }

    .application-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .application-actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .application-card {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .rank-badge {
        margin: 0 auto;
      }

      .applicant-details {
        justify-content: center;
      }
    }

    /* Batch Actions */
    .batch-actions-bar {
      display: none;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      margin-bottom: 1rem;
      color: white;
      flex-wrap: wrap;
    }
    .batch-actions-bar.active {
      display: flex;
    }
    .batch-actions-bar .selected-count {
      font-weight: 600;
    }
    .batch-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .batch-btn-accept {
      background: #10b981;
      color: white;
    }
    .batch-btn-accept:hover {
      background: #059669;
    }
    .batch-btn-not-selected {
      background: #6b7280;
      color: white;
    }
    .batch-btn-not-selected:hover {
      background: #4b5563;
    }
    .batch-btn-cancel {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .batch-btn-cancel:hover {
      background: rgba(255,255,255,0.3);
    }
    .app-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .application-card {
      grid-template-columns: 30px 60px 1fr auto;
    }
    .select-all-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: auto;
    }
    .select-all-container label {
      font-weight: 500;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <%- include('../partials/sidebar_sponsor') %>

  <div class="main-wrapper">
    <%- include('../partials/topbar', { pageTitle: 'Applications' }) %>

    <main class="page-content">
      <div class="container">
        <a href="/sponsor/offers/<%= scholarship.id %>" class="back-link">← Back to Scholarship Details</a>

        <div class="header">
          <h1><%= scholarship.scholarshipName %></h1>
          <p>Review and accept applicants for this scholarship</p>
        </div>

        <div class="info-banner">
          <strong>How it works:</strong>
          Use AI Ranking to sort applicants by best match, then accept the students you want.
          Accepted students will be reviewed by admin who will notify them. You can accept more students than available slots if needed.
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value"><%= stats.total %></div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card pending">
            <div class="stat-value"><%= stats.pending + stats.underReview %></div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card accepted">
            <div class="stat-value"><%= stats.accepted %></div>
            <div class="stat-label">Accepted</div>
          </div>
          <div class="stat-card notified">
            <div class="stat-value"><%= stats.notified %></div>
            <div class="stat-label">Notified</div>
          </div>
          <div class="stat-card">
            <div class="stat-value"><%= stats.notSelected %></div>
            <div class="stat-label">Not Selected</div>
          </div>
          <div class="stat-card">
            <div class="stat-value"><%= scholarship.slotsFilled || 0 %>/<%= scholarship.slotsAvailable %></div>
            <div class="stat-label">Slots Filled</div>
          </div>
        </div>

        <div class="actions-bar">
          <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" onchange="filterApplications()">
              <option value="all">All Applications</option>
              <option value="pending">Pending</option>
              <option value="under_review">Ranked</option>
              <option value="accepted">Accepted</option>
              <option value="notified">Notified</option>
              <option value="not_selected">Not Selected</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="sortBy">Sort by:</label>
            <select id="sortBy" onchange="sortApplications()">
              <option value="rank">Ranking (Best Match)</option>
              <option value="gpa">GPA (Highest First)</option>
              <option value="date">Application Date</option>
            </select>
          </div>

          <% if (applications.length > 0) { %>
            <div class="select-all-container">
              <input type="checkbox" id="selectAllApps" class="app-checkbox" onchange="toggleSelectAll()">
              <label for="selectAllApps">Select All</label>
            </div>
            <button class="btn btn-primary" onclick="rankAllApplications()">
              AI Rank Applications
            </button>
          <% } %>
        </div>

        <% if (applications.length > 0) { %>
          <!-- Batch Actions Bar -->
          <div class="batch-actions-bar" id="batchActionsBar">
            <span class="selected-count"><span id="selectedCount">0</span> applications selected</span>
            <button class="batch-btn batch-btn-accept" onclick="batchAction('accepted')">Accept Selected</button>
            <button class="batch-btn batch-btn-not-selected" onclick="batchAction('not_selected')">Mark Not Selected</button>
            <button class="batch-btn batch-btn-cancel" onclick="clearSelection()">Cancel</button>
          </div>

          <div class="applications-list" id="applicationsList">
            <% applications.forEach((app, index) => {
              // Only show rank numbers for pending/under_review applications
              const isRanked = ['pending', 'under_review'].includes(app.status);
              let rankClass = '';
              if (isRanked && app.rank === 1) rankClass = 'gold';
              else if (isRanked && app.rank === 2) rankClass = 'silver';
              else if (isRanked && app.rank === 3) rankClass = 'bronze';
              else if (app.status === 'accepted') rankClass = 'accepted-badge';
              else if (app.status === 'notified') rankClass = 'notified-badge';
              else if (app.status === 'not_selected') rankClass = 'not-selected-badge';
              else if (!app.rank) rankClass = 'unranked';

              let statusDisplay = app.status;
              if (app.status === 'under_review') statusDisplay = 'Ranked';
              else if (app.status === 'not_selected') statusDisplay = 'Not Selected';
              else statusDisplay = app.status.charAt(0).toUpperCase() + app.status.slice(1);
            %>
              <div class="application-card status-<%= app.status %>" data-status="<%= app.status %>" data-rank="<%= app.rankScore || 0 %>" data-gpa="<%= app.gpa %>" data-date="<%= app.createdAt %>" data-app-id="<%= app.id %>">
                <% if (['pending', 'under_review'].includes(app.status)) { %>
                  <input type="checkbox" class="app-checkbox app-select" data-app-id="<%= app.id %>" onchange="updateBatchSelection()">
                <% } else { %>
                  <div></div>
                <% } %>
                <div class="rank-badge <%= rankClass %>">
                  <% if (app.status === 'accepted' || app.status === 'notified') { %>
                    ✓
                  <% } else if (app.status === 'not_selected') { %>
                    ✗
                  <% } else if (isRanked && app.rank) { %>
                    <%= app.rank %>
                  <% } else { %>
                    --
                  <% } %>
                </div>
                <div class="applicant-info">
                  <div class="applicant-name"><%= app.studentName %></div>
                  <div class="applicant-details">
                    <div class="detail-item">
                      <strong>GPA:</strong> <%= app.gpa %>
                    </div>
                    <div class="detail-item">
                      <strong>Course:</strong> <%= app.course %>
                    </div>
                    <div class="detail-item">
                      <strong>Year:</strong> <%= app.yearLevel %>
                    </div>
                    <% if (app.rankScore) { %>
                      <div class="detail-item">
                        <span class="match-score"><%= app.rankScore %>% Match</span>
                      </div>
                    <% } %>
                    <div class="detail-item">
                      <span class="status-badge status-<%= app.status %>">
                        <%= statusDisplay %>
                      </span>
                    </div>
                  </div>
                  <div class="detail-item">
                    <strong>Applied:</strong> <%= new Date(app.createdAt).toLocaleDateString() %>
                  </div>
                  <% if (app.recommendation) { %>
                    <div class="detail-item" style="margin-top: 0.5rem; font-style: italic;">
                      "<%= app.recommendation %>"
                    </div>
                  <% } %>
                </div>
                <div class="application-actions">
                  <a href="/sponsor/applications/<%= app.id %>" class="btn btn-primary">View Details</a>
                  <% if (['pending', 'under_review'].includes(app.status)) { %>
                    <button class="btn btn-accept" onclick="acceptApplicant('<%= app.id %>', '<%= app.studentName %>')">
                      Accept
                    </button>
                  <% } else if (app.status === 'accepted') { %>
                    <button class="btn btn-undo" onclick="undoAccept('<%= app.id %>')">
                      Undo Accept
                    </button>
                  <% } %>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <h3>No Applications Yet</h3>
            <p>Applications for this scholarship will appear here once students start applying.</p>
          </div>
        <% } %>
      </div>
    </main>

    <%- include('../partials/footer') %>
  </div>

  <script src="/js/sidebar.js"></script>
  <script>
    function filterApplications() {
      const status = document.getElementById('statusFilter').value;
      const cards = document.querySelectorAll('.application-card');

      cards.forEach(card => {
        if (status === 'all' || card.dataset.status === status) {
          card.style.display = 'grid';
        } else {
          card.style.display = 'none';
        }
      });
    }

    function sortApplications() {
      const sortBy = document.getElementById('sortBy').value;
      const list = document.getElementById('applicationsList');
      const cards = Array.from(list.querySelectorAll('.application-card'));

      cards.sort((a, b) => {
        if (sortBy === 'rank') {
          return parseFloat(b.dataset.rank) - parseFloat(a.dataset.rank);
        } else if (sortBy === 'gpa') {
          return parseFloat(b.dataset.gpa) - parseFloat(a.dataset.gpa);
        } else if (sortBy === 'date') {
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        }
        return 0;
      });

      cards.forEach(card => list.appendChild(card));
    }

    async function rankAllApplications() {
      if (!confirm('This will use AI to rank all pending applications based on their fit with the scholarship criteria. Continue?')) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Ranking...';

      try {
        const response = await fetch('/sponsor/offers/<%= scholarship.id %>/applications/rank', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          alert(`Successfully ranked ${result.rankings.length} applications!`);
          window.location.reload();
        } else {
          alert(result.error || 'Failed to rank applications');
          btn.disabled = false;
          btn.textContent = 'AI Rank Applications';
        }
      } catch (error) {
        alert('An error occurred while ranking applications');
        btn.disabled = false;
        btn.textContent = 'AI Rank Applications';
      }
    }

    async function acceptApplicant(applicationId, studentName) {
      if (!confirm(`Accept ${studentName} for this scholarship? Admin will be able to notify them.`)) {
        return;
      }

      try {
        const response = await fetch(`/sponsor/applications/${applicationId}/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'accepted' })
        });

        const result = await response.json();

        if (result.success) {
          window.location.reload();
        } else {
          alert(result.error || 'Failed to accept applicant');
        }
      } catch (error) {
        alert('An error occurred');
      }
    }

    async function undoAccept(applicationId) {
      if (!confirm('Undo acceptance? The applicant will be moved back to pending review.')) {
        return;
      }

      try {
        const response = await fetch(`/sponsor/applications/${applicationId}/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'under_review' })
        });

        const result = await response.json();

        if (result.success) {
          window.location.reload();
        } else {
          alert(result.error || 'Failed to undo acceptance');
        }
      } catch (error) {
        alert('An error occurred');
      }
    }

    // Batch selection functions
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllApps');
      const checkboxes = document.querySelectorAll('.app-select');
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
      });
      updateBatchSelection();
    }

    function updateBatchSelection() {
      const selected = document.querySelectorAll('.app-select:checked');
      const count = selected.length;
      const bar = document.getElementById('batchActionsBar');
      const countEl = document.getElementById('selectedCount');

      countEl.textContent = count;
      if (count > 0) {
        bar.classList.add('active');
      } else {
        bar.classList.remove('active');
      }
    }

    function clearSelection() {
      document.querySelectorAll('.app-select').forEach(cb => {
        cb.checked = false;
      });
      document.getElementById('selectAllApps').checked = false;
      updateBatchSelection();
    }

    async function batchAction(newStatus) {
      const selected = document.querySelectorAll('.app-select:checked');
      const applicationIds = Array.from(selected).map(cb => cb.dataset.appId);

      if (applicationIds.length === 0) {
        alert('No applications selected');
        return;
      }

      const statusLabel = newStatus === 'accepted' ? 'accept' : 'mark as not selected';
      if (!confirm(`Are you sure you want to ${statusLabel} ${applicationIds.length} application(s)?`)) {
        return;
      }

      try {
        const response = await fetch('/sponsor/applications/batch-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ applicationIds, status: newStatus })
        });

        const result = await response.json();

        if (result.success) {
          alert(result.message);
          window.location.reload();
        } else {
          alert('Error: ' + (result.error || 'Failed to update applications'));
        }
      } catch (error) {
        console.error(error);
        alert('An error occurred while updating applications');
      }
    }
  </script>
</body>
</html>
